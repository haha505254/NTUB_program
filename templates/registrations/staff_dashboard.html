{% extends "base.html" %}

{% block title %}櫃檯儀表板{% endblock %}

{% block content %}
<h1>櫃檯作業</h1>
<p>提供病患查詢、現場掛號、報到與資料維護的工作台。</p>

<nav class="tab-bar" aria-label="病患作業模式切換">
  <a
    href="{% url 'registrations:staff-dashboard' %}?mode=search{% if current_identifier %}&identifier={{ current_identifier }}{% endif %}"
    class="tab{% if active_mode == 'search' %} active{% endif %}"
    >病患查詢</a
  >
  <a
    href="{% url 'registrations:staff-dashboard' %}?mode=create"
    class="tab{% if active_mode == 'create' %} active{% endif %}"
    >新增病患</a
  >
</nav>

{% if active_mode == "search" %}
  <section class="card">
    <h2>病患查詢</h2>
    <form method="get" class="filter-bar">
      <input type="hidden" name="mode" value="search">
      <div class="field">
        {{ search_form.identifier.label_tag }}
        {{ search_form.identifier }}
      </div>
      <div class="field-actions">
        <button type="submit" class="secondary btn-compact">查詢病患</button>
        <p class="help-text" style="margin: 0;">可輸入病歷號或身分證號。</p>
      </div>
    </form>
  </section>

  {% if selected_patient %}
    <section class="card">
      <h2>病患資料</h2>
      <p>
        病歷號：<strong>{{ selected_patient.medical_record_number }}</strong> ／
        姓名：<strong>{{ selected_patient.user.display_name }}</strong>
      </p>
      <form method="post" action="{% url 'registrations:staff-patient-update' selected_patient.pk %}" class="stack">
        {% csrf_token %}
        {% for field in patient_form %}
          <div>
            {{ field.label_tag }}
            {{ field }}
            {% if field.help_text %}<small class="help-text">{{ field.help_text }}</small>{% endif %}
          </div>
        {% endfor %}
        <div class="form-actions">
          <button type="submit">儲存資料</button>
        </div>
      </form>
    </section>

    <section class="card">
      <h2>現場掛號</h2>
      <form method="post" action="{% url 'registrations:staff-appointment-create' selected_patient.pk %}" class="stack">
        {% csrf_token %}
        {% for field in appointment_form %}
          <div>
            {{ field.label_tag }}
            {{ field }}
            {% if field.help_text %}<small class="help-text">{{ field.help_text }}</small>{% endif %}
          </div>
        {% endfor %}
        <div class="form-actions">
          <button type="submit">建立掛號</button>
        </div>
        <p class="help-text">只會顯示今日起尚可掛號的門診時段。</p>
      </form>
    </section>

    <section class="card">
      <h2>掛號紀錄</h2>
      {% if appointments %}
        <table>
          <thead>
            <tr>
              <th>號碼</th>
              <th>門診資訊</th>
              <th>狀態</th>
              <th>動作</th>
            </tr>
          </thead>
          <tbody>
            {% for appointment in appointments %}
              <tr>
                <td>#{{ appointment.queue_number }}</td>
                <td>
                  {{ appointment.schedule.date|date:"Y-m-d" }}
                  {{ appointment.schedule.get_session_display }} ／
                  {{ appointment.schedule.doctor.department.name }}
                  {{ appointment.schedule.doctor.user.display_name }}
                </td>
                <td>{{ appointment.get_status_display }}</td>
                <td class="actions">
                  <div class="button-set">
                    {% if appointment.status == 'reserved' %}
                      <form method="post" action="{% url 'registrations:staff-appointment-check-in' appointment.pk %}">
                        {% csrf_token %}
                        <button type="submit" class="btn-compact">報到</button>
                      </form>
                    {% endif %}
                    {% if appointment.status != 'cancelled' and appointment.status != 'completed' %}
                      <form method="post" action="{% url 'registrations:staff-appointment-cancel' appointment.pk %}">
                        {% csrf_token %}
                        <button type="submit" class="secondary btn-compact">取消</button>
                      </form>
                    {% endif %}
                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <p>目前尚無掛號紀錄。</p>
      {% endif %}
    </section>
  {% endif %}
{% else %}
  <section class="card">
    <h2>新增病患</h2>
    <p class="help-text">完成建檔後系統會自動產生病歷號與登入帳號。</p>
    <form method="post" action="{% url 'registrations:staff-patient-create' %}" class="stack">
      {% csrf_token %}
      {% for field in patient_create_form %}
        <div>
          {{ field.label_tag }}
          {{ field }}
          {% if field.help_text %}<small class="help-text">{{ field.help_text }}</small>{% endif %}
        </div>
      {% endfor %}
      <div class="form-actions">
        <button type="submit">建立病患資料</button>
      </div>
    </form>
  </section>
{% endif %}

<section class="card">
  <h2>快速連結</h2>
  <ul>
    <li><a href="{% url 'registrations:clinic-status' %}">查看門診狀態</a></li>
  </ul>
</section>
{% endblock %}
